<!DOCTYPE html>
<html lang="ja">
<head>
 <meta charset="UTF-8">
 <meta name="viewport" content="width=device-width, initial-scale=1.0">
 <title>tweets recap</title>
<style> * { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, "Noto Sans", sans-serif; padding: 0.5rem; line-height: 1.3; background-color: #f7f7f7; color: #666; font-size: 0.9rem; } .container { max-width: 600px; margin: 0 auto; padding: 0.5rem; border-radius: 4px; background-color: #f7f7f7; } @media (max-width: 767px) { .container { max-width: 100%; padding: 0.5rem; margin: 0; } } .header-section { display: flex; justify-content: flex-start; align-items: center; gap: 0.5rem; padding: 0.5rem 0; border-bottom: 0px solid #ddd; } .header-buttons { display: flex; gap: 0.5rem; } .header-buttons button, .container button { border: none; font-size: 0.8rem; padding: 0.5rem 0.8rem; border-radius: 999px; font-weight: bold; cursor: pointer; background-color: #ffb366; color: #fff; transition: background-color 0.3s ease, color 0.3s ease; } .header-buttons button:hover, .container button:hover { background-color: #ffa347; } #main-event { padding: 1rem 0; border-bottom: 1px dashed #ddd; } .profile { display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem; } .profile-image { width: 2rem; height: 2rem; border-radius: 50%; object-fit: cover; } .profile-name { font-weight: bold; font-size: 1rem; color: #444; } .profile-nip05, .profile-npub { font-size: 0.8rem; color: #999; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; } .post-info { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: #999; margin-top: 0.25rem; } .post-content { margin-top: 0.5rem; line-height: 1.5; word-wrap: break-word; overflow-wrap: break-word; } .post-content img { max-width: 100%; height: auto; display: block; margin-top: 0.5rem; } .custom-emoji { height: 1.2rem; vertical-align: middle; display: inline-block; } .nostr-link { color: #66b3ff; text-decoration: none; } .nostr-link:hover { text-decoration: underline; } .section-header { margin: 1rem 0 0.5rem; font-size: 1rem; color: #444; font-weight: bold; } .reactions-list { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 0.5rem; } .reaction-group { display: flex; align-items: center; gap: 0.2rem; background-color: #eee; border-radius: 999px; padding: 0.2rem 0.5rem; font-size: 0.8rem; } .reaction-emoji { font-size: 1rem; } .reaction-avatars { display: flex; flex-direction: row-reverse; } .reaction-avatar { width: 1.2rem; height: 1.2rem; border-radius: 50%; object-fit: cover; border: 1px solid #fff; margin-left: -0.5rem; } .related-posts { margin-top: 1rem; } .related-post-card { background-color: #fff; border: 1px solid #ddd; border-radius: 4px; padding: 0.5rem; margin-bottom: 0.5rem; } .related-post-card .profile-image { width: 1.5rem; height: 1.5rem; } .related-post-card .profile-name, .related-post-card .profile-npub { font-size: 0.8rem; } .related-post-card .post-content { font-size: 0.8rem; margin-top: 0.25rem; } #status { margin-top: 0.5rem; font-weight: bold; color: #ff99cc; text-align: center; } .footer-section { text-align: center; padding: 1rem 0; } </style>
</head>
<body>
<div id="header-placeholder"></div>
 <div class="container">
 <div class="header-section">
 <button onclick="goBack()">もどる</button>
 <button onclick="copyUrl()">シェア</button>
 </div> 
 <div id="main-event">
 </div>
 <p id="status"></p>
 <div id="reactions-section" style="display: none;">
 <h2 class="section-header">リアクション</h2>
 <div id="reactions-list" class="reactions-list"></div>
 </div> 
 <div id="related-events-section" style="display: none;">
 <h2 class="section-header">関連イベント</h2>
 <div id="related-events-list" class="related-posts"></div>
 </div>
 <div class="footer-section">
 <button onclick="goBack()">もどる</button>
 </div>
 </div>
<script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.bundle.js"></script>
<script>
// ==========================================================
// 初期設定とグローバル変数
// ==========================================================
// DOMエレメントの取得
const mainEventContainer = document.getElementById('main-event');
const statusElement = document.getElementById('status');
const reactionsSection = document.getElementById('reactions-section');
const reactionsList = document.getElementById('reactions-list');
const relatedEventsSection = document.getElementById('related-events-section');
const relatedEventsList = document.getElementById('related-events-list');

// リレーとnostr-toolsの初期設定
const RELAY_URLS = [
    'wss://relay.nostr.band',
    'wss://nos.lol',
    // 他にもリレーを追加可能
];
const pool = new window.NostrTools.SimplePool();
const userProfiles = {}; // pubkey -> profile キャッシュ

// リレー接続状態をコンソールに表示
RELAY_URLS.forEach(url => {
    pool.ensureRelay(url).then(relay => {
        relay.on('connect', () => console.log(`✅ リレーに接続しました: ${url}`));
        relay.on('disconnect', () => console.warn(`⚠️ リレーから切断されました: ${url}`));
        relay.on('error', () => console.error(`❌ リレー接続エラー: ${url}`));
    }).catch(err => {
        console.error(`接続プールの設定中にエラーが発生しました: ${url}`, err);
    });
});

// ==========================================================
// ヘルパー関数
// ==========================================================

/**
 * ステータスメッセージの表示
 * @param {string} message - 表示するメッセージ
 */
function showStatus(message) {
    statusElement.textContent = message;
    statusElement.style.display = message ? 'block' : 'none';
}

/**
 * HTMLエスケープ処理
 * @param {string} str - エスケープする文字列
 * @returns {string} エスケープ後の文字列
 */
function escapeHtml(str) {
    if (!str) return '';
    return str.replace(/[&<>"']/g, function(match) {
        const escape = { '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' };
        return escape[match];
    });
}

/**
 * Nostrリンクを自身のビューアへのURLに変換
 * @param {string} nip19 - nostr:リンクの文字列
 * @returns {string} 変換後のURL
 */
function createNostrLink(nip19) {
    try {
        const decoded = window.NostrTools.nip19.decode(nip19);
        const { type, data } = decoded;

        if (type === 'note' || type === 'nevent') {
            return `?nevent=${nip19}`;
        } else if (type === 'npub' || type === 'nprofile') {
            const pubkey = data.id || data;
            const npub = window.NostrTools.nip19.npubEncode(pubkey);
            return `?npub=${npub}`;
        }
        return '#';
    } catch (e) {
        console.error('Failed to decode nostr link:', e);
        return '#';
    }
}

/**
 * 投稿本文のフォーマット
 * @param {string} content - 投稿本文
 * @param {Array<string[]>} tags - イベントタグ
 * @returns {string} フォーマット後のHTML文字列
 */
function formatPostContent(content, tags) {
    let formattedContent = escapeHtml(content);

    // URLを自動リンク化
    formattedContent = formattedContent.replace(/(https?:\/\/[^\s]+)/g, (url) => {
        // 画像の拡張子を持つURLは<img>タグに変換
        if (/\.(png|jpe?g|gif|webp|svg|heic|avif)$/i.test(url)) {
            return `<img src="${url}" alt="post image" class="post-image">`;
        }
        return `<a href="${url}" target="_blank" rel="noopener noreferrer">${url}</a>`;
    });

    // nostr:リンクの変換
    formattedContent = formattedContent.replace(/nostr:(n(?:pub|event|note|profile|relay)1\S+)/g, (match, nip19) => {
        const link = createNostrLink(nip19);
        return `<a href="${link}" class="nostr-link">${match}</a>`;
    });

    // カスタム絵文字の処理 (NIP-30)
    const customEmojis = tags.filter(t => t[0] === 'emoji');
    customEmojis.forEach(([_, shortcode, url]) => {
        const regex = new RegExp(`:${shortcode}:`, 'g');
        formattedContent = formattedContent.replace(regex, `<img src="${url}" alt="${shortcode}" class="custom-emoji">`);
    });

    // 改行を<br>に変換
    return formattedContent.replace(/\n/g, '<br>');
}

/**
 * プロフィール情報を取得し、キャッシュに保存
 * @param {string[]} pubkeys - 取得するpubkeyの配列
 */
async function fetchProfiles(pubkeys) {
    if (pubkeys.length === 0) return;
    const profiles = await pool.list(RELAY_URLS, [{ kinds: [0], authors: pubkeys }]);
    profiles.forEach(p => {
        try {
            userProfiles[p.pubkey] = JSON.parse(p.content);
        } catch (e) {
            console.error('❌ プロフィールJSONのパースに失敗しました:', p.pubkey, e);
        }
    });
}

/**
 * 投稿者のプロフィールHTMLを生成
 * @param {string} pubkey - 投稿者の公開鍵
 * @returns {string} プロフィールHTML
 */
function createProfileHtml(pubkey) {
    const profile = userProfiles[pubkey] || { name: 'Unknown', picture: 'https://via.placeholder.com/128' };
    const npub = window.NostrTools.nip19.npubEncode(pubkey);
    const profileUrl = `?npub=${npub}`;

    return `
        <a href="${profileUrl}" class="profile-link">
            <div class="profile">
                <img src="${profile.picture}" class="profile-image" alt="User profile image">
                <div>
                    <span class="profile-name">${escapeHtml(profile.name)}</span>
                    <span class="profile-nip05">${profile.nip05 ? escapeHtml(profile.nip05) : npub.substring(0, 8) + '...' + npub.slice(-4)}</span>
                </div>
            </div>
        </a>
    `;
}

// ==========================================================
// レンダリング関数
// ==========================================================

/**
 * メイン投稿の表示
 * @param {object} event - kind:1 イベントオブジェクト
 */
function renderMainEvent(event) {
    const date = new Date(event.created_at * 1000).toLocaleString();
    const client = event.tags.find(t => t[0] === 'client')?.[1] || '';

    const html = `
        ${createProfileHtml(event.pubkey)}
        <div class="post-content">${formatPostContent(event.content, event.tags)}</div>
        <div class="post-info">
            <span>${date}</span>
            ${client ? `<span>via ${escapeHtml(client)}</span>` : ''}
        </div>
    `;
    mainEventContainer.innerHTML = html;
}

/**
 * リアクションをグループ化して表示
 * @param {object[]} reactions - kind:7 イベントの配列
 */
function renderReactions(reactions) {
    const reactionGroups = new Map();
    reactions.forEach(reaction => {
        const emoji = reaction.content.trim();
        if (!reactionGroups.has(emoji)) {
            reactionGroups.set(emoji, { count: 0, pubkeys: new Set() });
        }
        const group = reactionGroups.get(emoji);
        group.count++;
        group.pubkeys.add(reaction.pubkey);
    });

    reactionsList.innerHTML = '';
    for (const [emoji, group] of reactionGroups.entries()) {
        const avatarsHtml = Array.from(group.pubkeys).map(pubkey => {
            const profile = userProfiles[pubkey] || { picture: 'https://via.placeholder.com/128' };
            const npub = window.NostrTools.nip19.npubEncode(pubkey);
            const profileUrl = `?npub=${npub}`;
            return `<a href="${profileUrl}"><img src="${profile.picture}" class="reaction-avatar" alt="reaction user avatar"></a>`;
        }).join('');

        const groupHtml = `
            <div class="reaction-group">
                <span class="reaction-emoji">${emoji}</span>
                <div class="reaction-avatars">${avatarsHtml}</div>
            </div>
        `;
        reactionsList.innerHTML += groupHtml;
    }
    reactionsSection.style.display = 'block';
}

/**
 * 関連イベント（リプライ・リポスト・引用）を表示
 * @param {object[]} posts - kind:1 リプライイベントの配列
 * @param {object[]} reposts - kind:6 リポストイベントの配列
 * @param {object[]} quotes - kind:16 引用イベントの配列
 */
function renderRelatedEvents(posts, reposts, quotes) {
    const allRelatedEvents = [...posts, ...reposts, ...quotes];
    allRelatedEvents.sort((a, b) => b.created_at - a.created_at);
    relatedEventsList.innerHTML = '';

    allRelatedEvents.forEach(event => {
        const date = new Date(event.created_at * 1000).toLocaleString();
        let postContentHtml = '';
        let postTypeLabel = '';

        switch (event.kind) {
            case 1:
                postTypeLabel = 'リプライ';
                postContentHtml = `<div class="post-content">${formatPostContent(event.content, event.tags)}</div>`;
                break;
            case 6:
                postTypeLabel = 'リポスト';
                const repostUser = userProfiles[event.pubkey] || { name: 'Unknown' };
                postContentHtml = `<div class="post-content">${escapeHtml(repostUser.name)}さんがリポストしました</div>`;
                break;
            case 16:
                postTypeLabel = '引用';
                postContentHtml = `<div class="post-content">${formatPostContent(event.content, event.tags)}</div>`;
                break;
        }

        const html = `
            <div class="related-post-card">
                ${createProfileHtml(event.pubkey)}
                <div class="post-info">
                    <span>${date}</span>
                    <span>${postTypeLabel}</span>
                </div>
                ${postContentHtml}
            </div>
        `;
        relatedEventsList.innerHTML += html;
    });
    relatedEventsSection.style.display = 'block';
}

/**
 * イベント詳細ページをレンダリングする
 * @param {string} nevent - NostrイベントID（nevent形式）
 */
async function renderEventDetail(nevent) {
    showStatus('イベントデータを取得中...');
    try {
        const decoded = window.NostrTools.nip19.decode(nevent);
        if (decoded.type !== 'nevent') {
            showStatus('エラー: 無効なnevent形式です。');
            return;
        }
        const eventId = decoded.data.id;
        console.log(`ℹ️ イベントID ${eventId} の取得を開始します。`);

        const mainEventPromise = pool.get(RELAY_URLS, { ids: [eventId], kinds: [1] });
        const relatedEventsPromise = pool.list(RELAY_URLS, [{ '#e': [eventId], kinds: [1, 6, 7, 16] }]);
        const [mainEvent, relatedEvents] = await Promise.all([mainEventPromise, relatedEventsPromise]);

        if (!mainEvent) {
            showStatus('イベントが見つかりませんでした');
            return;
        }

        const pubkeysToFetch = new Set();
        pubkeysToFetch.add(mainEvent.pubkey);
        relatedEvents.forEach(e => pubkeysToFetch.add(e.pubkey));
        await fetchProfiles(Array.from(pubkeysToFetch));

        renderMainEvent(mainEvent);

        const reactions = relatedEvents.filter(e => e.kind === 7);
        const posts = relatedEvents.filter(e => e.kind === 1);
        const reposts = relatedEvents.filter(e => e.kind === 6);
        const quotes = relatedEvents.filter(e => e.kind === 16);

        if (reactions.length > 0) renderReactions(reactions);
        if (posts.length > 0 || reposts.length > 0 || quotes.length > 0) {
            renderRelatedEvents(posts, reposts, quotes);
        }

        showStatus('');
        console.log('✅ すべての処理が完了しました。');
    } catch (err) {
        console.error('❌ イベントの取得中にエラーが発生しました:', err);
        showStatus('イベントの取得中にエラーが発生しました。');
    } finally {
        pool.close(RELAY_URLS);
    }
}

/**
 * プロフィール詳細ページをレンダリングする
 * @param {string} npub - Nostr公開鍵（npub形式）
 */
async function renderProfileDetail(npub) {
    showStatus('プロフィール情報を取得中...');
    try {
        const decoded = window.NostrTools.nip19.decode(npub);
        if (decoded.type !== 'npub' && decoded.type !== 'nprofile') {
            showStatus('エラー: 無効なnpub形式です。');
            return;
        }
        const pubkey = decoded.data.id || decoded.data;

        const profileEvent = await pool.get(RELAY_URLS, { kinds: [0], authors: [pubkey] });
        if (!profileEvent) {
            showStatus('プロフィールが見つかりませんでした。');
            return;
        }

        const profile = JSON.parse(profileEvent.content);
        const html = `
            <div class="profile-card">
                <img src="${profile.picture}" alt="Profile Picture">
                <h2>${escapeHtml(profile.name)}</h2>
                <p class="npub">${window.NostrTools.nip19.npubEncode(pubkey)}</p>
                <p class="about">${escapeHtml(profile.about || '')}</p>
                <p class="nip05">${profile.nip05 ? escapeHtml(profile.nip05) : 'NIP-05未設定'}</p>
            </div>
        `;
        mainEventContainer.innerHTML = html;
        showStatus('');
    } catch (err) {
        console.error('プロフィール取得中にエラー:', err);
        showStatus('プロフィールの取得中にエラーが発生しました。');
    } finally {
        pool.close(RELAY_URLS);
    }
}

/**
 * イベント/プロフィールIDの入力フォームを動的に生成して表示する
 */
function renderInputForm() {
    mainEventContainer.innerHTML = `
        <div class="input-form-container">
            <h3 class="form-title">イベントまたはユーザーのNostr IDを入力してください</h3>
            <form id="nostr-form" class="nostr-form">
                <input type="text" id="nostr-id-input" placeholder="nevent1..., npub1..." required class="form-input">
                <button type="submit" class="form-button">表示</button>
            </form>
        </div>
    `;
    const form = document.getElementById('nostr-form');
    form.addEventListener('submit', (e) => {
        e.preventDefault();
        const input = document.getElementById('nostr-id-input').value.trim();
        if (input.startsWith('nevent1') || input.startsWith('note1')) {
            window.location.href = `?nevent=${input}`;
        } else if (input.startsWith('npub1') || input.startsWith('nprofile1')) {
            window.location.href = `?npub=${input}`;
        } else {
            alert('有効なNostr ID (nevent, npub, note, nprofile) を入力してください。');
        }
    });
}

// ==========================================================
// メインエントリーポイント
// ==========================================================
window.onload = () => {
    const urlParams = new URLSearchParams(window.location.search);
    const nevent = urlParams.get('nevent');
    const npub = urlParams.get('npub');

    if (nevent) {
        renderEventDetail(nevent);
    } else if (npub) {
        renderProfileDetail(npub);
    } else {
        renderInputForm();
    }
};
</script>
<script src="https://ompomz.github.io/header/loadHeader.js"></script>
</body>
</html>
