<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <title>Nostrプロフィール取得ツール</title>
  <script src="https://cdn.jsdelivr.net/npm/nostr-tools@2.1.2/lib/nostr.bundle.min.js"></script>
  <style>
    textarea, button { margin: 5px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 5px; text-align: left; }
    th button { margin-left: 10px; }
  </style>
</head>
<body>
  <h2>Nostrプロフィール取得ツール</h2>
  <textarea id="pubkey-input" rows="4" cols="80" placeholder="hexまたはnpubを改行またはカンマで区切って入力"></textarea>
  <br>
  <button onclick="getProfiles()">プロフィール取得 (kind:0)</button>

  <table id="profile-table">
    <thead>
      <tr>
        <th>name <button onclick="copyColumn(0)">すべてコピー</button></th>
        <th>display_name <button onclick="copyColumn(1)">すべてコピー</button></th>
        <th>hex <button onclick="copyColumn(2)">すべてコピー</button></th>
        <th>npub <button onclick="copyColumn(3)">すべてコピー</button></th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const relayURL = "wss://relay.nostr.band";

    function decodeNpub(npub) {
      try {
        return window.NostrTools.nip19.decode(npub).data;
      } catch {
        return null;
      }
    }

    function getProfiles() {
      const input = document.getElementById("pubkey-input").value;
      const keys = input.split(/[\s,]+/).filter(Boolean);
      const pubkeys = keys.map(k => k.startsWith("npub1") ? decodeNpub(k) : k).filter(k => /^[a-f0-9]{64}$/i.test(k));

      if (pubkeys.length === 0) return alert("有効な公開鍵がありません");

      document.querySelector("#profile-table tbody").innerHTML = '';
      const socket = new WebSocket(relayURL);

      socket.onopen = () => {
        const req = ["REQ", "profile-req", { kinds: [0], authors: pubkeys }];
        socket.send(JSON.stringify(req));
      };

      socket.onmessage = (event) => {
        const [type,, eventData] = JSON.parse(event.data);
        if (type === "EVENT") {
          try {
            const profile = JSON.parse(eventData.content);
            const name = profile.name || "";
            const displayName = profile.display_name || "";
            const hex = eventData.pubkey;
            const npub = window.NostrTools.nip19.npubEncode(hex);

            const row = document.createElement("tr");
            row.innerHTML = `<td>${name}</td><td>${displayName}</td><td>${hex}</td><td>${npub}</td>`;
            document.querySelector("#profile-table tbody").appendChild(row);
          } catch {
            console.warn("プロフィール解析失敗");
          }
        }
      };
    }

    function copyColumn(index) {
      const rows = document.querySelectorAll(`#profile-table tbody tr`);
      const values = Array.from(rows).map(row => row.cells[index].textContent).join("\n");
      navigator.clipboard.writeText(values).then(() => alert("コピーしました！"));
    }
  </script>
</body>
</html>
