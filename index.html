<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nostr Note Deletion Tool</title>
</head>
<body>
    <p>kind:1のNoteを削除するためのツールです。削除したいNoteのIDと秘密鍵を入力し、kind:5イベントをリレーに送信します。</p>
    <label for="noteId">削除したいNote ID (e.g., note1...):</label>
    <input type="text" id="noteId" placeholder="note1z2he85z0vvy5h74tfk5zdkhjqll485vnhlyt9calz9gggn8al7rsyahpx8">
    <label for="relays">Kind:5を送信するリレーURL (複数指定可、改行区切り):</label>
    <textarea id="relays" rows="5" placeholder="wss://relay.damus.io&#10;wss://nos.lol"></textarea>
    <label for="privateKeyHex">秘密鍵 (hex):</label>
    <input type="text" id="privateKeyHex" placeholder="例: c968153d... (注意: 公開しないように!)">
    <button id="createJsonButton">JSONを作成</button>
    <button id="signAndSendButton" disabled>署名して送信</button>
    <pre id="eventJsonPreview"></pre>
    <div id="results">結果がここに表示されます。</div>
<script src="https://unpkg.com/nostr-tools@1.17.0/lib/nostr.min.js"></script>
<script>
  const { nip19, getPublicKey, getEventHash, schnorr } = NostrTools;

  const noteIdInput = document.getElementById('noteId');
  const relaysInput = document.getElementById('relays');
  const privateKeyHexInput = document.getElementById('privateKeyHex');
  const createJsonButton = document.getElementById('createJsonButton');
  const signAndSendButton = document.getElementById('signAndSendButton');
  const eventJsonPreview = document.getElementById('eventJsonPreview');
  const resultsDiv = document.getElementById('results');

  let eventToSign = null;

  async function finalizeEvent(event, privkey) {
    event.id = getEventHash(event);
    event.sig = await schnorr.sign(event.id, privkey);
    return event;
  }

  createJsonButton.addEventListener('click', async () => {
    resultsDiv.innerHTML = '';
    const noteId = noteIdInput.value.trim();
    let privkeyInput = privateKeyHexInput.value.trim();

    if (!noteId || !privkeyInput) {
      resultsDiv.innerHTML = '<span class="error">Note IDと秘密鍵をすべて入力してください。</span>';
      return;
    }

    try {
      // nsec形式ならhexに変換
      if (privkeyInput.startsWith('nsec')) {
        privkeyInput = nip19.decode(privkeyInput).data;
      }

      const { type, data } = nip19.decode(noteId);
      if (type !== 'note' && type !== 'nevent') {
        throw new Error('無効なNote IDです。');
      }

      const eventId = typeof data === 'string' ? data : data.id;
      const pubkey = getPublicKey(privkeyInput);

      eventToSign = {
        kind: 5,
        created_at: Math.floor(Date.now() / 1000),
        tags: [['e', eventId]],
        content: 'Note deleted by user.',
        pubkey: pubkey,
      };

      const finalEvent = await finalizeEvent(eventToSign, privkeyInput);
      eventJsonPreview.textContent = JSON.stringify(finalEvent, null, 2);
      signAndSendButton.disabled = false;
      resultsDiv.innerHTML = '<span class="success">✅ JSONが作成されました。内容を確認し、「署名して送信」ボタンを押してください。</span>';
    } catch (e) {
      eventJsonPreview.textContent = '';
      signAndSendButton.disabled = true;
      resultsDiv.innerHTML = `<span class="error">⚠️ エラー: ${e.message}</span>`;
    }
  });

  signAndSendButton.addEventListener('click', async () => {
    if (!eventToSign) {
      resultsDiv.innerHTML = '<span class="error">先にJSONを作成してください。</span>';
      return;
    }

    signAndSendButton.disabled = true;
    resultsDiv.innerHTML = '送信中...';

    const relays = relaysInput.value.trim().split('\n').filter(url => url.startsWith('wss://') || url.startsWith('ws://'));
    let privkeyInput = privateKeyHexInput.value.trim();
    if (privkeyInput.startsWith('nsec')) {
      privkeyInput = nip19.decode(privkeyInput).data;
    }

    if (relays.length === 0) {
      resultsDiv.innerHTML = '<span class="error">有効なリレーURLが入力されていません。</span>';
      signAndSendButton.disabled = false;
      return;
    }

    const event = await finalizeEvent(eventToSign, privkeyInput);
    resultsDiv.innerHTML = '';

    for (const relayUrl of relays) {
      const relayResultDiv = document.createElement('div');
      relayResultDiv.innerHTML = `<h3>${relayUrl}</h3>`;
      resultsDiv.appendChild(relayResultDiv);

      try {
        const ws = new WebSocket(relayUrl);
        ws.onopen = () => {
          relayResultDiv.innerHTML += '<p>接続成功。イベントを送信中...</p>';
          ws.send(JSON.stringify(['EVENT', event]));
        };
        ws.onmessage = (message) => {
          const msg = JSON.parse(message.data);
          if (msg[0] === 'OK') {
            const [ok, eventId, success, reason] = msg;
            if (success) {
              relayResultDiv.innerHTML += `<p class="success">✅ <b>送信成功:</b> ${reason || ''}</p>`;
            } else {
              relayResultDiv.innerHTML += `<p class="error">❌ <b>送信失敗:</b> ${reason || '不明なエラー'}</p>`;
            }
          }
          ws.close();
        };
        ws.onerror = (e) => {
          relayResultDiv.innerHTML += `<p class="error">❌ 接続エラー: ${e.message}</p>`;
          ws.close();
        };
        ws.onclose = () => {
          relayResultDiv.innerHTML += '<hr>';
        };
      } catch (e) {
        relayResultDiv.innerHTML += `<p class="error">❌ 接続または送信中にエラーが発生しました: ${e.message}</p><hr>`;
      }
    }

    signAndSendButton.disabled = false;
  });
</script>
</body>
</html>
